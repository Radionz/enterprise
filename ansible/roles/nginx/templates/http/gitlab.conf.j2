proxy_cache_path /tmp/nginx_uploads_cache levels=1:2 keys_zone=uploads_cache:10m max_size=2g inactive=3m use_temp_path=off;

upstream gitlab-backend {
  server localhost:8050;
  # server localhost:8051;
}

{% if nginx_deploy_ssl %}
server {
  server_name              {{ gitlab_hostname }} www.{{ gitlab_hostname }};

  listen                   443 ssl http2;
  listen                   [::]:443 ssl http2;

  {% if nginx_use_letsencrypt %}
  ssl_certificate          /etc/letsencrypt/live/{{ gitlab_hostname }}/fullchain.pem;
  ssl_certificate_key      /etc/letsencrypt/live/{{ gitlab_hostname }}/privkey.pem;
  {% else %}
  ssl_certificate          {{ nginx_certificate_path }};
  ssl_certificate_key      {{ nginx_key_path }};
  {% endif %}
  ssl_session_cache        shared:SSL:20m;
  ssl_session_timeout      60m;
  ssl_protocols            TLSv1 TLSv1.1 TLSv1.2;
  ssl_prefer_server_ciphers on;
  ssl_ciphers              ECDH+AESGCM:ECDH+AES256:ECDH+AES128:DH+3DES:!ADH:!AECDH:!MD5;
  add_header               Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
  server_tokens off;

  location / {
    client_max_body_size 0;
    gzip off;

    ## https://github.com/gitlabhq/gitlabhq/issues/694
    ## Some requests take more than 30 seconds.
    proxy_read_timeout      300;
    proxy_connect_timeout   300;
    proxy_redirect          off;

    proxy_http_version 1.1;

    proxy_set_header    Host                $http_host;
    proxy_set_header    X-Real-IP           $remote_addr;
    proxy_set_header    X-Forwarded-Ssl     on;
    proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header    X-Forwarded-Proto   $scheme;
    proxy_set_header    X-Frame-Options     SAMEORIGIN;
    proxy_pass 		http://gitlab-backend;

    {% if gitlab_whitelist_ips %}{% for ip in gitlab_ips_to_whitelist %}allow {{ ip }};
    {% endfor %}
    allow {{ inventory_hostname }};
    allow 127.0.0.0/8;
    allow 192.0.0.0/24;
    allow 10.0.0.0/8;
    allow 172.16.0.0/12;
    deny all;
    {% endif %}
  }

  location /.well-known/ {
    root                /var/le-challenges/{{ gitlab_hostname }};
  }
}

server {
  server_tokens off;
  server_name              {{ gitlab_hostname }} www.{{ gitlab_hostname }};

  listen                   80;
  listen                   [::]:80;

  return                   301 https://$server_name$request_uri;

  {% if gitlab_whitelist_ips %}{% for ip in gitlab_ips_to_whitelist %}allow {{ ip }};
  {% endfor %}
  allow 127.0.0.0/8;
  allow 192.0.0.0/24;
  allow 127.0.0.0/8;
  allow 10.0.0.0/8;
  allow 172.16.0.0/12;
  allow {{ inventory_hostname }};
  deny all;
  {% endif %}
}

{% if gitlab_enable_dual_dns %}
server {
   server_tokens off;
   server_name              {{ gitlab_dual_hostname }} www.{{ gitlab_dual_hostname }};
   listen                   443 ssl http2;
   listen                   [::]:443 ssl http2;
   ssl_certificate          {{ gitlab_dual_cert_path }};
   ssl_certificate_key      {{ gitlab_dual_key_path }};

   location ~ ^\S+\/\S+\.git(.*)$ {
      client_max_body_size 0;
      gzip off;

      ## https://github.com/gitlabhq/gitlabhq/issues/694
      ## Some requests take more than 30 seconds.
      proxy_read_timeout      300;
      proxy_connect_timeout   300;
      proxy_redirect          off;

      proxy_http_version 1.1;

      proxy_set_header    Host                $http_host;
      proxy_set_header    X-Real-IP           $remote_addr;
      proxy_set_header    X-Forwarded-Ssl     on;
      proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
      proxy_set_header    X-Forwarded-Proto   $scheme;
      proxy_pass 	  http://gitlab-backend/$request_uri;
   }

   location ~ ^/(uploads|assets)/ {
      client_max_body_size 0;
      add_header Cache-Control max-age=365000;
      gzip on;

      ## https://github.com/gitlabhq/gitlabhq/issues/694
      ## Some requests take more than 30 seconds.
      proxy_read_timeout      300;
      proxy_connect_timeout   300;
      proxy_redirect          off;

      proxy_cache uploads_cache;

      proxy_http_version 1.1;

      proxy_set_header    Host                $http_host;
      proxy_set_header    X-Real-IP           $remote_addr;
      proxy_set_header    X-Forwarded-Ssl     on;
      proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
      proxy_set_header    X-Forwarded-Proto   $scheme;
      proxy_pass 	  http://gitlab-backend;
   }

   location /.well-known/ {
      root                /var/le-challenges/{{ gitlab_dual_hostname }};
   }

}

{% endif %}

{% else %}
server {
  listen                   80;
  listen                   [::]:80;
  server_name              {{ gitlab_hostname }} www.{{ gitlab_hostname }};
  server_tokens off;

  location / {
      client_max_body_size 0;
      gzip off;

      ## https://github.com/gitlabhq/gitlabhq/issues/694
      ## Some requests take more than 30 seconds.
      proxy_read_timeout      300;
      proxy_connect_timeout   300;
      proxy_redirect          off;
      proxy_http_version 1.1;

      proxy_set_header    Host                $http_host;
      proxy_set_header    X-Real-IP           $remote_addr;
      proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
      proxy_set_header    X-Forwarded-Proto   $scheme;
      proxy_pass 	  http://gitlab-backend;

      {% if gitlab_whitelist_ips %}{% for ip in gitlab_ips_to_whitelist %}allow {{ ip }};
      {% endfor %}
      allow 127.0.0.0/8;
      allow 192.0.0.0/24;
      allow 127.0.0.0/8;
      allow 10.0.0.0/8;
      allow 172.16.0.0/12;
      allow {{ inventory_hostname }};
      deny all;
      {% endif %}
  }

  location /.well-known/ {
    root                /var/le-challenges/{{ gitlab_hostname }};
  }
}

{% if gitlab_enable_dual_dns %}
server {
   server_tokens off;
   server_name              {{ gitlab_dual_hostname }} www.{{ gitlab_dual_hostname }};
   listen                   80;
   listen                   [::]:80;

   location ~ ^\S+\/\S+\.git(.*)$ {
      client_max_body_size 0;
      gzip off;

      ## https://github.com/gitlabhq/gitlabhq/issues/694
      ## Some requests take more than 30 seconds.
      proxy_read_timeout      300;
      proxy_connect_timeout   300;
      proxy_redirect          off;

      proxy_http_version 1.1;

      proxy_set_header    Host                $http_host;
      proxy_set_header    X-Real-IP           $remote_addr;
      proxy_set_header    X-Forwarded-Ssl     on;
      proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
      proxy_set_header    X-Forwarded-Proto   $scheme;
      proxy_pass 	  http://gitlab-backend/$request_uri;
   }

   location /uploads {
      client_max_body_size 0;
      gzip on;
      add_header Cache-Control max-age=365000;

      ## https://github.com/gitlabhq/gitlabhq/issues/694
      ## Some requests take more than 30 seconds.
      proxy_read_timeout      300;
      proxy_connect_timeout   300;
      proxy_redirect          off;

      proxy_cache uploads_cache;

      proxy_http_version 1.1;

      proxy_set_header    Host                $http_host;
      proxy_set_header    X-Real-IP           $remote_addr;
      proxy_set_header    X-Forwarded-Ssl     on;
      proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
      proxy_set_header    X-Forwarded-Proto   $scheme;
      proxy_pass 	  http://gitlab-backend/uploads;
   }

   location /.well-known/ {
      root                /var/le-challenges/{{ gitlab_dual_hostname }};
   }
}

{% endif %}

{% endif %}